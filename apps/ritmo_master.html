<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ritmo Master Pro - WAV Edition</title>

<style>
    :root {
        --primary: #2e7dff;
        --bg: #121212;
        --surface: #1e1e1e;
        --note-bg: rgba(46, 125, 255, 0.2);
        --success: #4caf50;
        --error: #ff5252;
    }

    body {
        font-family: 'Segoe UI', sans-serif;
        background: var(--bg);
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
    }

    .card {
        background: var(--surface);
        padding: 25px;
        border-radius: 20px;
        max-width: 700px;
        width: 100%;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
    }

    /* === SELECTOR DE DIFICULTAD === */
    .difficulty-selector {
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        background: #2a2a2a;
        padding: 10px 15px;
        border-radius: 10px;
    }

    select {
        background: #444;
        color: white;
        border: 1px solid var(--primary);
        padding: 5px;
        border-radius: 5px;
        cursor: pointer;
    }

    .staff {
        background: #f8f9fa;
        height: 100px;
        border-radius: 12px;
        margin: 20px 0;
        display: flex;
        position: relative;
        overflow: hidden;
        border: 2px solid #333;
        background-image: linear-gradient(to right, #e0e0e0 1px, transparent 1px);
        background-size: 25% 100%;
    }

    .note-slot {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        border-right: 1px solid rgba(0,0,0,0.1);
        background: var(--note-bg);
        transition: width 0.3s ease;
    }

    .note-slot span {
        color: #111;
        font-size: 2.8rem;
    }

    .empty-slot {
        flex-grow: 1;
        background: repeating-linear-gradient(45deg, #222, #222 10px, #2a2a2a 10px, #2a2a2a 20px);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #555;
        font-size: 0.8rem;
    }

    .menu { display: flex; justify-content: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }

    .fig-btn {
        background: #333;
        border: none;
        padding: 12px;
        border-radius: 10px;
        color: white;
        cursor: pointer;
        font-size: 1.4rem;
        transition: 0.2s;
        min-width: 60px;
    }

    .fig-btn:hover:not(:disabled) { background: var(--primary); transform: translateY(-2px); }
    .fig-btn:disabled { opacity: 0.3; cursor: not-allowed; }

    .controls { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;}
    
    button.main { background: var(--primary); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer;}
    button.secondary { background: #444; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer;}

    .label { font-size: 0.8rem; color: #888; margin-bottom: 5px; display: block; }
    
    #loading-msg { color: #ffeb3b; font-size: 0.9rem; margin-bottom: 10px; }
</style>
</head>
<body>

<div class="card">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2>üéº Ritmo Master</h2>
        <div>Puntos: <b id="score">0</b></div>
    </div>

    <div class="difficulty-selector">
        <span>Nivel de Dificultad:</span>
        <select id="difficulty" onchange="nextRound()">
            <option value="1">1 - Redondas y Blancas</option>
            <option value="2">2 - A√±ade Negras</option>
            <option value="3">3 - Iniciaci√≥n Corcheas</option>
            <option value="4">4 - Corcheas Mixtas</option>
            <option value="5">5 - Semicorcheas</option>
            <option value="6">6 - Ritmos R√°pidos</option>
            <option value="7">7 - Maestro del Ritmo</option>
        </select>
    </div>

    <div id="loading-msg">Cargando sonido...</div>

    <div class="controls">
        <button class="main" id="playBtn" onclick="playSolution()" disabled>‚ñ∂ Escuchar Reto</button>
        <button class="secondary" onclick="check()">Validar</button>
        <button class="secondary" onclick="nextRound()">Siguiente</button>
    </div>

    <span class="label">Tus notas (Comp√°s 4/4):</span>
    <div id="player-staff" class="staff"></div>

    <div class="menu">
        <button id="btn-W" class="fig-btn" onclick="add('W')">ùÖù</button>
        <button id="btn-H" class="fig-btn" onclick="add('H')">ùÖóùÖ•</button>
        <button id="btn-Q" class="fig-btn" onclick="add('Q')">‚ô©</button>
        <button id="btn-E" class="fig-btn" onclick="add('E')">‚ô™</button>
        <button id="btn-S" class="fig-btn" onclick="add('S')">ùÖòùÖ•ùÖØ</button>
        <button class="fig-btn" onclick="remove()" style="background:#c62828">‚å´</button>
    </div>

    <div id="solution-area" style="display:none">
        <span class="label">Soluci√≥n correcta:</span>
        <div id="solution-staff" class="staff" style="background-color: #e8f5e9; height: 60px;"></div>
    </div>
    
    <p id="status" style="text-align:center; font-weight: bold; min-height: 1.2em;"></p>
</div>

<script>
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let soundBuffer = null;

const figures = { W: 'ùÖù', H: 'ùÖóùÖ•', Q: '‚ô©', E: '‚ô™', S: 'ùÖòùÖ•ùÖØ' };
const values = { W: 4, H: 2, Q: 1, E: 0.5, S: 0.25 };

// Configuraci√≥n de niveles: define qu√© notas est√°n disponibles
const levels = {
    1: ['W', 'H'],
    2: ['W', 'H', 'Q'],
    3: ['H', 'Q', 'E'],
    4: ['Q', 'E'],
    5: ['Q', 'E', 'S'],
    6: ['E', 'S'],
    7: ['W', 'H', 'Q', 'E', 'S']
};

let solution = [];
let userInput = [];
let score = 0;

// --- CARGA DE SONIDO ---
async function initAudio() {
    try {
        // Sustituye esta URL por tu archivo .wav real
        const response = await fetch('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
        const arrayBuffer = await response.arrayBuffer();
        soundBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        
        document.getElementById('loading-msg').style.display = 'none';
        document.getElementById('playBtn').disabled = false;
    } catch (e) {
        document.getElementById('loading-msg').textContent = "Error al cargar audio. Usa un servidor local.";
        console.error(e);
    }
}

function playWav(startTime, duration) {
    if (!soundBuffer) return;
    const source = audioCtx.createBufferSource();
    const gain = audioCtx.createGain();
    
    source.buffer = soundBuffer;
    
    gain.gain.setValueAtTime(1, startTime);
    gain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
    
    source.connect(gain);
    gain.connect(audioCtx.destination);
    
    source.start(startTime);
    source.stop(startTime + duration);
}

// --- L√ìGICA DEL JUEGO ---

function updateButtonAvailability() {
    const currentLevel = document.getElementById('difficulty').value;
    const allowed = levels[currentLevel];
    
    Object.keys(figures).forEach(key => {
        document.getElementById('btn-' + key).disabled = !allowed.includes(key);
    });
}

function generateChallenge() {
    let compas = []; 
    let rem = 4;
    const currentLevel = document.getElementById('difficulty').value;
    const availableKeys = levels[currentLevel];

    while(rem > 0) {
        let f = availableKeys[Math.floor(Math.random() * availableKeys.length)];
        if(values[f] <= rem) { 
            compas.push(f); 
            rem -= values[f]; 
        } else {
            // Si la nota elegida no cabe, intentamos con la m√°s peque√±a disponible
            const minVal = Math.min(...availableKeys.map(k => values[k]));
            if (rem < minVal) break; // No cabe nada m√°s
        }
    }
    return compas;
}

function add(f) {
    let total = userInput.reduce((s, v) => s + values[v], 0);
    if(total + values[f] <= 4) {
        userInput.push(f);
        renderStaff('player-staff', userInput, true);
    }
}

function remove() {
    userInput.pop();
    renderStaff('player-staff', userInput, true);
}

function renderStaff(id, notes, showRemaining) {
    const el = document.getElementById(id);
    let html = '';
    let totalUsed = 0;

    notes.forEach(f => {
        const width = (values[f] / 4) * 100;
        totalUsed += values[f];
        html += `<div class="note-slot" style="width: ${width}%"><span>${figures[f]}</span></div>`;
    });

    if(showRemaining && totalUsed < 4) {
        const remWidth = ((4 - totalUsed) / 4) * 100;
        html += `<div class="empty-slot" style="width: ${remWidth}%">${(4-totalUsed).toFixed(2)} restantes</div>`;
    }

    el.innerHTML = html;
}

function playSolution() {
    if (audioCtx.state === 'suspended') audioCtx.resume();
    
    let now = audioCtx.currentTime + 0.1;
    let timeAcc = 0;
    const bpmFactor = 0.6; // Velocidad del juego

    solution.forEach(f => {
        playWav(now + timeAcc, (values[f] * bpmFactor) - 0.02);
        timeAcc += values[f] * bpmFactor;
    });
}

function check() {
    document.getElementById('solution-area').style.display = 'block';
    renderStaff('solution-staff', solution, false);
    
    const isCorrect = JSON.stringify(solution) === JSON.stringify(userInput);
    const status = document.getElementById('status');
    
    if(isCorrect) {
        score += (100 * document.getElementById('difficulty').value);
        status.textContent = "¬°Excelente! Ritmo clavado.";
        status.style.color = "var(--success)";
    } else {
        status.textContent = "El ritmo no coincide. ¬°Int√©ntalo de nuevo!";
        status.style.color = "var(--error)";
    }
    document.getElementById('score').textContent = score;
}

function nextRound() {
    updateButtonAvailability();
    solution = generateChallenge();
    userInput = [];
    document.getElementById('solution-area').style.display = 'none';
    document.getElementById('status').textContent = "";
    renderStaff('player-staff', userInput, true);
}

// Inicializaci√≥n
initAudio();
nextRound();
</script>
</body>
</html>
