<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bordes con grosor por sombra (fondo blanco)</title>
<style>
  body {
    background:#111;
    color:#eee;
    font-family:sans-serif;
    text-align:center;
    margin:0;
    padding:10px;
  }

  h2 {
    font-size:1.2em;
  }

  input[type=file], label {
    display:block;
    margin:10px auto;
    font-size:1em;
  }

  input[type=range] {
    width: 80%;
    max-width: 400px;
    margin:5px auto 15px auto;
  }

  canvas {
    display:block;
    margin:10px auto;
    max-width:100%;
    height:auto;
    border:1px solid #888;
    background:white; /* fondo blanco */
  }
</style>
</head>
<body>

<h2>Bordes con grosor según sombras</h2>

<input type="file" id="upload" accept="image/*">

<label>Umbral de borde
  <input type="range" id="threshold" min="10" max="200" value="60">
</label>

<label>Grosor máximo
  <input type="range" id="maxWidth" min="1" max="8" value="4">
</label>

<canvas id="canvas"></canvas>

<script>
const upload = document.getElementById("upload");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const thresholdInput = document.getElementById("threshold");
const maxWidthInput = document.getElementById("maxWidth");

let img = new Image();

upload.addEventListener("change", e => {
  const reader = new FileReader();
  reader.onload = () => {
    img.onload = () => process();
    img.src = reader.result;
  };
  reader.readAsDataURL(e.target.files[0]);
});

thresholdInput.addEventListener("input", process);
maxWidthInput.addEventListener("input", process);

function process() {
  if (!img.src) return;

  const maxScreenWidth = window.innerWidth * 0.95;
  const scale = Math.min(1, maxScreenWidth / img.width);
  const displayWidth = img.width * scale;
  const displayHeight = img.height * scale;

  canvas.width = img.width;  
  canvas.height = img.height;

  // llenar fondo blanco
  ctx.fillStyle = "white";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // obtener datos de la imagen
  const tmpCanvas = document.createElement("canvas");
  tmpCanvas.width = img.width;
  tmpCanvas.height = img.height;
  const tmpCtx = tmpCanvas.getContext("2d");
  tmpCtx.drawImage(img,0,0);
  const src = tmpCtx.getImageData(0,0,tmpCanvas.width,tmpCanvas.height);
  const gray = new Float32Array(src.width * src.height);

  for(let i=0;i<gray.length;i++){
    const r = src.data[i*4];
    const g = src.data[i*4+1];
    const b = src.data[i*4+2];
    gray[i] = (r+g+b)/3;
  }

  ctx.strokeStyle="black";
  const w = canvas.width;
  const h = canvas.height;
  const threshold = thresholdInput.value;
  const maxWidth = maxWidthInput.value;

  for(let y=1;y<h-1;y++){
    for(let x=1;x<w-1;x++){
      const i = y*w+x;

      const gx =
        -gray[i-w-1] + gray[i-w+1] +
        -2*gray[i-1] + 2*gray[i+1] +
        -gray[i+w-1] + gray[i+w+1];

      const gy =
        -gray[i-w-1] - 2*gray[i-w] - gray[i-w+1] +
         gray[i+w-1] + 2*gray[i+w] + gray[i+w+1];

      const mag = Math.hypot(gx,gy);

      if(mag > threshold){
        const contrast =
          Math.abs(gray[i]-gray[i+1]) +
          Math.abs(gray[i]-gray[i-1]) +
          Math.abs(gray[i]-gray[i+w]) +
          Math.abs(gray[i]-gray[i-w]);
        const width = Math.min(maxWidth, contrast/50);

        ctx.lineWidth = width;
        ctx.beginPath();
        ctx.moveTo(x, y);
        ctx.lineTo(x+0.5, y+0.5);
        ctx.stroke();
      }
    }
  }

  canvas.style.width = displayWidth + "px";
  canvas.style.height = displayHeight + "px";
}
</script>

</body>
</html>

